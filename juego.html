<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piedra, Papel o Tijeras - Gestos</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils_3d/control_utils_3d.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
            width: 100%;
        }

        .video-section {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
        }

        .video-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.8);
        }

        #videoElement {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1); /* Mirror effect */
        }

        #canvasElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* Mirror effect */
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 10;
        }

        .game-section {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .status-card, .score-card, .controls-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .status-card {
            text-align: center;
        }

        .game-state {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .gesture-display {
            font-size: 3rem;
            margin: 10px 0;
        }

        .countdown {
            font-size: 2rem;
            color: #ffeb3b;
            font-weight: bold;
        }

        .score-card {
            text-align: center;
        }

        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .score-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .score-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .controls-card {
            text-align: center;
        }

        .gesture-guide {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .gesture-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .gesture-item.active {
            border-color: #4caf50;
            background: rgba(76,175,80,0.2);
        }

        .gesture-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .gesture-name {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .start-instruction {
            background: rgba(255,193,7,0.2);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .result-display {
            margin: 15px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .result-win { color: #4caf50; }
        .result-lose { color: #f44336; }
        .result-tie { color: #ff9800; }

        .hands-detected {
            color: #4caf50;
            font-weight: bold;
        }

        .hands-count {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .gesture-guide {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            font-size: 1.2rem;
        }

        .error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ Piedra, Papel o Tijeras</h1>
        <p>¬°Juega usando gestos con tus manos!</p>
    </div>

    <div class="game-container">
        <div class="video-section">
            <div class="video-container">
                <video id="videoElement" autoplay muted playsinline></video>
                <canvas id="canvasElement"></canvas>
                <div class="video-overlay" id="videoStatus">
                    <div class="loading">üé• Iniciando c√°mara y detecci√≥n de manos...</div>
                </div>
            </div>
        </div>

        <div class="game-section">
            <div class="status-card">
                <div class="game-state" id="gameState">¬°Levanta ambas manos para comenzar!</div>
                <div class="hands-count" id="handsCount">Manos detectadas: 0</div>
                <div class="gesture-display" id="gestureDisplay">ü§ö</div>
                <div class="countdown" id="countdown"></div>
                <div class="result-display" id="resultDisplay"></div>
            </div>

            <div class="score-card">
                <h3>üèÜ Puntuaci√≥n</h3>
                <div class="score-grid">
                    <div class="score-item">
                        <div class="score-label">Jugador</div>
                        <div class="score-value" id="playerScore">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Computadora</div>
                        <div class="score-value" id="computerScore">0</div>
                    </div>
                </div>
            </div>

            <div class="controls-card">
                <h3>üéØ Gestos del Juego</h3>
                <div class="gesture-guide">
                    <div class="gesture-item" id="rockGuide">
                        <div class="gesture-icon">‚úä</div>
                        <div class="gesture-name">Piedra</div>
                    </div>
                    <div class="gesture-item" id="paperGuide">
                        <div class="gesture-icon">‚úã</div>
                        <div class="gesture-name">Papel</div>
                    </div>
                    <div class="gesture-item" id="scissorsGuide">
                        <div class="gesture-icon">‚úåÔ∏è</div>
                        <div class="gesture-name">Tijeras</div>
                    </div>
                </div>
                
                <div class="start-instruction">
                    <strong>üöÄ Para comenzar:</strong><br>
                    Levanta ambas manos frente a la c√°mara y mant√©n por 2 segundos
                </div>
            </div>
        </div>
    </div>

    <script>
        class RPSGame {
            constructor() {
                this.videoElement = document.getElementById('videoElement');
                this.canvasElement = document.getElementById('canvasElement');
                this.canvasCtx = this.canvasElement.getContext('2d');
                
                this.gameState = 'waiting'; // waiting, starting, playing, showing_result
                this.playerScore = 0;
                this.computerScore = 0;
                this.currentGesture = 'none';
                this.handsDetected = 0;
                this.bothHandsStartTime = 0;
                this.bothHandsRequiredTime = 2000; // 2 segundos
                this.gameStartTime = 0;
                this.countdownTime = 3;
                
                this.hands = null;
                this.camera = null;
                
                this.initializeHandDetection();
            }

            async initializeHandDetection() {
                try {
                    // Inicializar MediaPipe Hands
                    this.hands = new Hands({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                        }
                    });

                    this.hands.setOptions({
                        maxNumHands: 2,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });

                    this.hands.onResults((results) => this.onHandsResults(results));

                    // Inicializar c√°mara
                    this.camera = new Camera(this.videoElement, {
                        onFrame: async () => {
                            await this.hands.send({ image: this.videoElement });
                        },
                        width: 640,
                        height: 480
                    });

                    await this.camera.start();
                    
                    document.getElementById('videoStatus').innerHTML = 'üéØ ¬°Listo! Levanta ambas manos para comenzar';
                    
                    this.startGameLoop();
                } catch (error) {
                    console.error('Error initializing hand detection:', error);
                    document.getElementById('videoStatus').innerHTML = 
                        '<span class="error">‚ùå Error: No se pudo inicializar la detecci√≥n de manos</span>';
                }
            }

            onHandsResults(results) {
                // Limpiar canvas
                this.canvasCtx.save();
                this.canvasCtx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                
                // Dibujar conexiones de las manos
                if (results.multiHandLandmarks) {
                    this.handsDetected = results.multiHandLandmarks.length;
                    
                    for (const landmarks of results.multiHandLandmarks) {
                        drawConnectors(this.canvasCtx, landmarks, HAND_CONNECTIONS, 
                            { color: '#00FF00', lineWidth: 5 });
                        drawLandmarks(this.canvasCtx, landmarks, 
                            { color: '#FF0000', lineWidth: 2 });
                    }

                    // Detectar gesto si estamos jugando
                    if (this.gameState === 'playing' && results.multiHandLandmarks.length > 0) {
                        this.currentGesture = this.detectGesture(results.multiHandLandmarks[0]);
                    }
                } else {
                    this.handsDetected = 0;
                }
                
                this.canvasCtx.restore();
            }

            detectGesture(landmarks) {
                if (!landmarks || landmarks.length < 21) return 'none';

                // Obtener puntos clave de la mano
                const thumb_tip = landmarks[4];
                const thumb_ip = landmarks[3];
                const index_tip = landmarks[8];
                const index_pip = landmarks[6];
                const middle_tip = landmarks[12];
                const middle_pip = landmarks[10];
                const ring_tip = landmarks[16];
                const ring_pip = landmarks[14];
                const pinky_tip = landmarks[20];
                const pinky_pip = landmarks[18];

                // Verificar si los dedos est√°n extendidos
                const fingers = [];
                
                // Pulgar (l√≥gica especial debido a su orientaci√≥n)
                fingers.push(thumb_tip.x > thumb_ip.x);
                
                // Otros dedos
                fingers.push(index_tip.y < index_pip.y);
                fingers.push(middle_tip.y < middle_pip.y);
                fingers.push(ring_tip.y < ring_pip.y);
                fingers.push(pinky_tip.y < pinky_pip.y);

                const extendedCount = fingers.filter(finger => finger).length;

                // Clasificar gestos
                if (extendedCount === 0) {
                    return 'rock'; // Pu√±o cerrado
                } else if (extendedCount === 5) {
                    return 'paper'; // Mano abierta
                } else if (extendedCount === 2 && fingers[1] && fingers[2]) {
                    return 'scissors'; // √çndice y medio extendidos
                }

                return 'none';
            }

            getComputerChoice() {
                const choices = ['rock', 'paper', 'scissors'];
                return choices[Math.floor(Math.random() * choices.length)];
            }

            determineWinner(playerGesture, computerGesture) {
                if (playerGesture === computerGesture) return 'tie';
                
                const winConditions = {
                    rock: 'scissors',
                    paper: 'rock',
                    scissors: 'paper'
                };
                
                return winConditions[playerGesture] === computerGesture ? 'win' : 'lose';
            }

            updateUI() {
                const gameStateElement = document.getElementById('gameState');
                const gestureDisplayElement = document.getElementById('gestureDisplay');
                const countdownElement = document.getElementById('countdown');
                const resultDisplayElement = document.getElementById('resultDisplay');
                const videoStatusElement = document.getElementById('videoStatus');
                const handsCountElement = document.getElementById('handsCount');

                // Actualizar contador de manos
                handsCountElement.textContent = `Manos detectadas: ${this.handsDetected}`;
                handsCountElement.className = this.handsDetected >= 2 ? 'hands-count hands-detected' : 'hands-count';

                // Actualizar gu√≠as de gestos
                document.querySelectorAll('.gesture-item').forEach(item => item.classList.remove('active'));
                if (this.currentGesture === 'rock') document.getElementById('rockGuide').classList.add('active');
                if (this.currentGesture === 'paper') document.getElementById('paperGuide').classList.add('active');
                if (this.currentGesture === 'scissors') document.getElementById('scissorsGuide').classList.add('active');

                switch (this.gameState) {
                    case 'waiting':
                        if (this.handsDetected >= 2) {
                            const timeHeld = Date.now() - this.bothHandsStartTime;
                            const timeLeft = Math.max(0, this.bothHandsRequiredTime - timeHeld);
                            const progress = Math.min(100, (timeHeld / this.bothHandsRequiredTime) * 100);
                            
                            gameStateElement.textContent = 'üôå ¬°Mant√©n ambas manos!';
                            gestureDisplayElement.textContent = 'üôå';
                            countdownElement.textContent = `${(timeLeft / 1000).toFixed(1)}s`;
                            videoStatusElement.innerHTML = `üöÄ Iniciando juego... ${progress.toFixed(0)}%`;
                        } else {
                            gameStateElement.textContent = 'ü§ö Levanta ambas manos para comenzar';
                            gestureDisplayElement.textContent = 'ü§ö';
                            countdownElement.textContent = '';
                            videoStatusElement.innerHTML = 'üéØ Muestra ambas manos para iniciar el juego';
                            this.bothHandsStartTime = Date.now();
                        }
                        resultDisplayElement.textContent = '';
                        break;

                    case 'starting':
                        const timeLeft = Math.ceil(this.countdownTime - (Date.now() - this.gameStartTime) / 1000);
                        if (timeLeft > 0) {
                            gameStateElement.textContent = '¬°Prep√°rate!';
                            countdownElement.textContent = timeLeft;
                            gestureDisplayElement.textContent = '‚è∞';
                            videoStatusElement.innerHTML = `‚è±Ô∏è Iniciando en ${timeLeft}... ¬°Prepara tu gesto!`;
                        }
                        break;

                    case 'playing':
                        gameStateElement.textContent = '‚úä ¬°Haz tu gesto!';
                        const gestureIcons = {
                            rock: '‚úä',
                            paper: '‚úã',
                            scissors: '‚úåÔ∏è',
                            none: 'ü§î'
                        };
                        gestureDisplayElement.textContent = gestureIcons[this.currentGesture] || 'ü§î';
                        countdownElement.textContent = '';
                        videoStatusElement.innerHTML = 'üéÆ Juego activo - Haz tu gesto';
                        break;

                    case 'showing_result':
                        // Se actualiza en showResult()
                        break;
                }

                // Actualizar puntuaci√≥n
                document.getElementById('playerScore').textContent = this.playerScore;
                document.getElementById('computerScore').textContent = this.computerScore;
            }

            showResult(playerGesture, computerGesture, result) {
                const gameStateElement = document.getElementById('gameState');
                const gestureDisplayElement = document.getElementById('gestureDisplay');
                const resultDisplayElement = document.getElementById('resultDisplay');
                const videoStatusElement = document.getElementById('videoStatus');

                const gestureIcons = {
                    rock: '‚úä',
                    paper: '‚úã',
                    scissors: '‚úåÔ∏è'
                };

                gameStateElement.textContent = 'Resultado';
                gestureDisplayElement.textContent = `${gestureIcons[playerGesture]} VS ${gestureIcons[computerGesture]}`;

                let resultText = '';
                let resultClass = '';

                switch (result) {
                    case 'win':
                        resultText = 'üéâ ¬°Ganaste!';
                        resultClass = 'result-win';
                        this.playerScore++;
                        break;
                    case 'lose':
                        resultText = 'üòû Perdiste';
                        resultClass = 'result-lose';
                        this.computerScore++;
                        break;
                    case 'tie':
                        resultText = 'ü§ù ¬°Empate!';
                        resultClass = 'result-tie';
                        break;
                }

                resultDisplayElement.textContent = resultText;
                resultDisplayElement.className = `result-display ${resultClass}`;
                videoStatusElement.innerHTML = 'üèÅ Resultado mostrado - Levanta ambas manos para jugar otra vez';

                // Volver al estado de espera despu√©s de 3 segundos
                setTimeout(() => {
                    this.gameState = 'waiting';
                    this.bothHandsStartTime = Date.now();
                    this.currentGesture = 'none';
                    this.updateUI();
                }, 3000);
            }

            startGameLoop() {
                const gameLoop = () => {
                    switch (this.gameState) {
                        case 'waiting':
                            if (this.handsDetected >= 2) {
                                const timeHeld = Date.now() - this.bothHandsStartTime;
                                if (timeHeld >= this.bothHandsRequiredTime) {
                                    this.gameState = 'starting';
                                    this.gameStartTime = Date.now();
                                }
                            } else {
                                this.bothHandsStartTime = Date.now();
                            }
                            break;

                        case 'starting':
                            const elapsed = (Date.now() - this.gameStartTime) / 1000;
                            if (elapsed >= this.countdownTime) {
                                this.gameState = 'playing';
                                this.gameStartTime = Date.now();
                                this.currentGesture = 'none';
                            }
                            break;

                        case 'playing':
                            // Terminar el juego despu√©s de 3 segundos
                            const playTime = (Date.now() - this.gameStartTime) / 1000;
                            if (playTime >= 3) {
                                const finalPlayerGesture = ['rock', 'paper', 'scissors'].includes(this.currentGesture) 
                                    ? this.currentGesture 
                                    : ['rock', 'paper', 'scissors'][Math.floor(Math.random() * 3)];
                                
                                const computerGesture = this.getComputerChoice();
                                const result = this.determineWinner(finalPlayerGesture, computerGesture);
                                
                                this.gameState = 'showing_result';
                                this.showResult(finalPlayerGesture, computerGesture, result);
                            }
                            break;
                    }

                    this.updateUI();
                    requestAnimationFrame(gameLoop);
                };

                gameLoop();
            }
        }

        // Inicializar el juego cuando la p√°gina est√© cargada
        document.addEventListener('DOMContentLoaded', () => {
            new RPSGame();
        });
    </script>
</body>
</html>